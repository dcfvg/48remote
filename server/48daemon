#!/bin/bash
# set -x

# helpers
function compilePDF (){

  now=$(date +"%y.%m.%d-%H.%M.%S")
  echo "get $1"
  phantomjs rasterize.js $1 "$assets/tmp.jpg" 3508px*4961px 1
  convert "$assets/tmp.jpg" -modulate 100,0 $printbox/$now.pdf
}
function preprocessimages (){
  
  inbox=$1
  detox -rv $inbox
  
  for pic in `find $inbox -iname "*.*" -type f`
  do
    pic_name=$(basename $pic)
    
    now=$(date +"%Y%m%d_%H%M%S")
    
    convert $pic -format jpg -auto-orient -resize 2000x -type GrayScaleMatte $import/$now.jpg
    mv $pic $archives/$pic_name
  done
}
function print {
  
  printinbox=$1
  printoutbox=$2
  
  printer=_192_168_1_35                    # labos
  detox -rv $printinbox
  
  for step in `find $printinbox -iname "*.pdf" -type f`
  do
    ((printcount++))
    
    stepname=$(basename $step)
    archivePath=$printoutbox$stepname
    
    mv -v $step $archivePath # copy in outbox (archives)
    lpr -P $printer -o media=A3 -o fit-to-page -o ColorModel=KGray $archivePath 
    
    printf "\t~ print \t $printcount \t\t $stepname \n\t_\t \t $(date +"%H.%M.%S")\n\n"
    
  done
}
function importFormShareFolder {
  
  source=$1
  target=$2
  mediatype=$3
  
  # count files
  filecount=$(find $source -type f ! -iname "*sync" ! -iname "*.DS_Store" -exec printf '.' \; | wc -c  | tr -d ' ')
  sourcename=$(basename $source)
  sourcetype=${sourcename: -3 :4}

  # pre-processing
  
  if [[ $filecount > 0 ]]
  then
    detox -rv $source
    mv -fv $source/* $target
    
    # for type in "${mediatype[@]}"; do
    #       case "$sourcetype" in
    #         pic) 
    #           sourcetypename="picture"
    #         ;;
    #         sca) 
    #           sourcetypename="scanner"
    #         ;;
    #         * ) 
    #           sourcetypename="Not processed"
    #           mv "$source/*.$type" $target
    #         ;;
    #       esac
    #     done
  fi
  
  printf "$sourcename \t $filecount file \t type : $sourcetypename ($sourcetype)\n\n"
}

# path
assets="assets/"
import=$assets"00-import"
printbox=$assets"01-printbox"
archives=$assets"02-archives"
replay=$assets"03-replay"
inboxsources=( "$import/photoNC" "$import/photoBV" "$import/scanpi" ) # "/Volumes/photo_canon" 

# params
interval=${1-10}
bgColor="#58bfff"
bgFuzz=20
printcount=0
mediatype=(jpg png md)

# main loop
while true; do
  clear
  echo "getsources ..."
  
  importFormShareFolder "$import/photoNC/" "$import/pictures/"
  importFormShareFolder "$import/photoBV/" "$import/pictures/"
  importFormShareFolder "$import/scanpi/" "$import/pictures/"
  importFormShareFolder "/Volumes/photo_canon/" "$import/pictures/"
  importFormShareFolder "$import/piscan/" "$import/pictures/"
  
  
  # image processing
  preprocessimages $import/pictures/
  
  # print
  compilePDF "http://localhost/poster/?refresh=truc"
  compilePDF "http://localhost/poster/?refresh=truc"
  compilePDF "http://localhost/poster/?refresh=truc"
  compilePDF "http://localhost/poster/"
  
  print $printbox $archives"/printedpdf/"
  say "print !"
  
  # wait
  for (( i=$interval; i>0; i--)); do
    sleep 1 &
    printf "next try in $i s \r"
    wait
    printf "                   \r"
  done
done